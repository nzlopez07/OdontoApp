{% extends "base.html" %}

{% block title %}
    {% if paciente %}Editar Paciente{% else %}Nuevo Paciente{% endif %} - Sistema de Gestión
{% endblock %}

{% macro render_field(field) %}
    <div class="mb-3">
        {{ field.label(class="form-label") }}
        {% if field.widget.input_type == 'hidden' %}
            {{ field() }}
        {% elif field.type == 'SelectField' and field.id == 'localidad_id' %}
            {# Autocomplete solo para localidad #}
            <div class="autocomplete-wrapper" style="position: relative;">
                <input type="text" 
                       class="form-control autocomplete-input" 
                       id="{{ field.id }}_search"
                       placeholder="Escribir para buscar..."
                       autocomplete="off">
                {{ field(class="d-none", id=field.id) }}
                <div class="autocomplete-list" style="position: absolute; z-index: 1000; width: 100%; max-height: 200px; overflow-y: auto; background: white; border: 1px solid #ced4da; border-top: none; display: none; border-radius: 0 0 0.25rem 0.25rem;"></div>
            </div>
        {% elif field.type == 'SelectField' %}
            {{ field(class="form-select" + (" is-invalid" if field.errors else "")) }}
        {% elif field.type == 'TextAreaField' %}
            {{ field(class="form-control" + (" is-invalid" if field.errors else ""), rows=3) }}
        {% else %}
            {{ field(class="form-control" + (" is-invalid" if field.errors else "")) }}
        {% endif %}
        {% if field.errors %}
            <div class="invalid-feedback d-block">
                {% for error in field.errors %}
                    <div>{{ error }}</div>
                {% endfor %}
            </div>
        {% endif %}
    </div>
{% endmacro %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4>
                    {% if paciente %}
                        <i class="bi bi-pencil"></i> Editar Paciente: {{ paciente.nombre }} {{ paciente.apellido }}
                    {% else %}
                        <i class="bi bi-person-plus"></i> Nuevo Paciente
                    {% endif %}
                </h4>
            </div>
            <div class="card-body">
                <form method="POST" novalidate>
                    {{ form.hidden_tag() }}
                    
                    <div class="row">
                        <div class="col-md-4">
                            {{ render_field(form.dni) }}
                        </div>
                        <div class="col-md-4">
                            {{ render_field(form.nombre) }}
                        </div>
                        <div class="col-md-4">
                            {{ render_field(form.apellido) }}
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6">
                            {{ render_field(form.fecha_nac) }}
                        </div>
                        <div class="col-md-6">
                            {{ render_field(form.telefono) }}
                        </div>
                    </div>
                    
                    <!-- Sección de Dirección -->
                    <hr class="my-4">
                    <h5 class="mb-3">Direcciones</h5>
                    <div class="row">
                        <div class="col-md-4">
                            {{ render_field(form.direccion) }}
                        </div>
                        <div class="col-md-4">
                            {{ render_field(form.barrio) }}
                        </div>
                        <div class="col-md-4">
                            {{ render_field(form.localidad_id) }}
                        </div>
                    </div>
                    
                    <!-- Sección de Obra Social -->
                    <hr class="my-4">
                    <h5 class="mb-3">Obra Social</h5>
                    <div class="row">
                        <div class="col-md-12">
                            {{ render_field(form.obra_social_id) }}
                        </div>
                    </div>
                    
                    <div id="campos-obra-social" style="display: none;">
                        <div class="row">
                            <div class="col-md-6">
                                {{ render_field(form.nro_afiliado) }}
                            </div>
                            <div class="col-md-6">
                                {{ render_field(form.lugar_trabajo) }}
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                {{ render_field(form.titular) }}
                            </div>
                            <div class="col-md-6">
                                {{ render_field(form.parentesco) }}
                            </div>
                        </div>
                    </div>

                    <!-- Botones -->
                    <div class="d-flex justify-content-between mt-4">
                        <a href="{{ url_for('main.listar_pacientes') }}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary">
                            {% if paciente %}
                                <i class="bi bi-check-lg"></i> Actualizar Paciente
                            {% else %}
                                <i class="bi bi-plus-lg"></i> Crear Paciente
                            {% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Validación de DNI en tiempo real
document.addEventListener('DOMContentLoaded', function() {
    const dniField = document.getElementById('dni');
    if (dniField) {
        dniField.addEventListener('input', function() {
            this.value = this.value.replace(/\D/g, '');
            if (this.value.length > 10) {
                this.value = this.value.substring(0, 10);
            }
        });
    }
    
    const telefonoField = document.getElementById('telefono');
    if (telefonoField) {
        telefonoField.addEventListener('input', function() {
            this.value = this.value.replace(/[^\d\-\+\s\(\)]/g, '');
        });
    }
    
    // Mostrar/ocultar campos de obra social
    const obraSocialSelect = document.getElementById('obra_social_id');
    const camposObraSocial = document.getElementById('campos-obra-social');
    
    function actualizarCamposObraSocial() {
        const selectedValue = obraSocialSelect.value;
        const selectedText = obraSocialSelect.options[obraSocialSelect.selectedIndex]?.text.toLowerCase() || '';
        
        if (selectedValue && selectedValue !== '0' && !selectedText.includes('particular')) {
            camposObraSocial.style.display = 'block';
        } else {
            camposObraSocial.style.display = 'none';
        }
    }
    
    if (obraSocialSelect) {
        actualizarCamposObraSocial();
        obraSocialSelect.addEventListener('change', actualizarCamposObraSocial);
    }
    
    // Autocomplete para selects
    function normalizeText(text) {
        // Normalizar texto removiendo tildes/acentos para búsqueda insensible
        return text.normalize('NFD').replace(/[\u0300-\u036f]/g, '').toLowerCase();
    }
    
    function setupAutocomplete(selectElement) {
        const wrapper = selectElement.closest('.autocomplete-wrapper');
        if (!wrapper) return;
        
        const input = wrapper.querySelector('.autocomplete-input');
        const list = wrapper.querySelector('.autocomplete-list');
        
        if (!input || !list) return;
        
        // Obtener todas las opciones del select
        const options = Array.from(selectElement.options).map(opt => ({
            value: opt.value,
            text: opt.text,
            normalized: normalizeText(opt.text)
        }));
        
        // Pre-poblar el input si hay un valor seleccionado
        const selectedOption = options.find(opt => opt.value == selectElement.value);
        if (selectedOption && selectedOption.value !== '0') {
            input.value = selectedOption.text;
        }
        
        // Filtrar y mostrar resultados
        input.addEventListener('input', function() {
            const searchTerm = normalizeText(this.value.trim());
            
            if (searchTerm === '') {
                list.style.display = 'none';
                selectElement.value = '0';
                return;
            }
            
            const filtered = options.filter(opt => 
                opt.normalized.includes(searchTerm) && opt.value !== '0'
            );
            
            if (filtered.length === 0) {
                list.innerHTML = '<div class="p-2 text-muted">No se encontraron resultados</div>';
                list.style.display = 'block';
                selectElement.value = '0';
                return;
            }
            
            list.innerHTML = filtered.map(opt => 
                `<div class="autocomplete-item p-2" style="cursor: pointer;" data-value="${opt.value}">${opt.text}</div>`
            ).join('');
            
            list.style.display = 'block';
            
            // Agregar hover effect
            list.querySelectorAll('.autocomplete-item').forEach(item => {
                item.addEventListener('mouseenter', function() {
                    this.style.backgroundColor = '#f8f9fa';
                });
                item.addEventListener('mouseleave', function() {
                    this.style.backgroundColor = 'white';
                });
                item.addEventListener('click', function() {
                    const value = this.getAttribute('data-value');
                    const text = this.textContent;
                    selectElement.value = value;
                    input.value = text;
                    list.style.display = 'none';
                    
                    // Trigger change event para obra social
                    selectElement.dispatchEvent(new Event('change'));
                });
            });
        });
        
        // Cerrar lista al hacer click fuera
        document.addEventListener('click', function(e) {
            if (!wrapper.contains(e.target)) {
                list.style.display = 'none';
            }
        });
        
        // Mostrar todas las opciones al hacer foco
        input.addEventListener('focus', function() {
            if (this.value === '') {
                const allOptions = options.filter(opt => opt.value !== '0');
                list.innerHTML = allOptions.map(opt => 
                    `<div class="autocomplete-item p-2" style="cursor: pointer;" data-value="${opt.value}">${opt.text}</div>`
                ).join('');
                
                list.querySelectorAll('.autocomplete-item').forEach(item => {
                    item.addEventListener('mouseenter', function() {
                        this.style.backgroundColor = '#f8f9fa';
                    });
                    item.addEventListener('mouseleave', function() {
                        this.style.backgroundColor = 'white';
                    });
                    item.addEventListener('click', function() {
                        const value = this.getAttribute('data-value');
                        const text = this.textContent;
                        selectElement.value = value;
                        input.value = text;
                        list.style.display = 'none';
                        selectElement.dispatchEvent(new Event('change'));
                    });
                });
                
                list.style.display = 'block';
            }
        });
    }
    
    // Aplicar autocomplete solo a localidad
    const localidadSelect = document.getElementById('localidad_id');
    if (localidadSelect) setupAutocomplete(localidadSelect);
});
</script>
{% endblock %}
