{% extends "base.html" %}

{% block title %}
    {% if paciente %}Editar Paciente{% else %}Nuevo Paciente{% endif %} - Sistema de Gestión
{% endblock %}

{% block content %}
<div class="row justify-content-center">
    <div class="col-md-8">
        <div class="card">
            <div class="card-header">
                <h4>
                    {% if paciente %}
                        <i class="bi bi-pencil"></i> Editar Paciente: {{ paciente.nombre }} {{ paciente.apellido }}
                    {% else %}
                        <i class="bi bi-person-plus"></i> Nuevo Paciente
                    {% endif %}
                </h4>
            </div>
            <div class="card-body">
                <form method="POST">
                    <div class="row">
                        <!-- DNI -->
                        <div class="col-md-4 mb-3">
                            <label for="dni" class="form-label">DNI *</label>
                            <input type="text" class="form-control" id="dni" name="dni" 
                                   value="{{ paciente.dni if paciente else '' }}" required>
                        </div>

                        <!-- Nombre -->
                        <div class="col-md-4 mb-3">
                            <label for="nombre" class="form-label">Nombre *</label>
                            <input type="text" class="form-control" id="nombre" name="nombre" 
                                   value="{{ paciente.nombre if paciente else '' }}" required>
                        </div>

                        <!-- Apellido -->
                        <div class="col-md-4 mb-3">
                            <label for="apellido" class="form-label">Apellido *</label>
                            <input type="text" class="form-control" id="apellido" name="apellido" 
                                   value="{{ paciente.apellido if paciente else '' }}" required>
                        </div>
                    </div>

                    <div class="row">
                        <!-- Fecha de Nacimiento -->
                        <div class="col-md-4 mb-3">
                            <label for="fecha_nac" class="form-label">Fecha de Nacimiento</label>
                            <input type="date" class="form-control" id="fecha_nac" name="fecha_nac" 
                                   value="{{ paciente.fecha_nac.strftime('%Y-%m-%d') if paciente and paciente.fecha_nac else '' }}">
                        </div>

                        <!-- Teléfono -->
                        <div class="col-md-4 mb-3">
                            <label for="telefono" class="form-label">Teléfono</label>
                            <input type="tel" class="form-control" id="telefono" name="telefono" 
                                   value="{{ paciente.telefono if paciente else '' }}">
                        </div>

                        <!-- Lugar de trabajo -->
                        <div class="col-md-4 mb-3">
                            <label for="lugar_trabajo" class="form-label">Lugar de trabajo</label>
                            <input type="text" class="form-control" id="lugar_trabajo" name="lugar_trabajo" 
                                   value="{{ paciente.lugar_trabajo if paciente else '' }}">
                        </div>
                    </div>

                    <!-- Sección de Dirección -->
                    <hr class="my-4">
                    <h5 class="mb-3">Direcciones</h5>
                    <div class="row">
                        <!-- Dirección -->
                        <div class="col-md-4 mb-3">
                            <label for="direccion" class="form-label">Dirección</label>
                            <input type="text" class="form-control" id="direccion" name="direccion" 
                                   value="{{ paciente.direccion if paciente else '' }}">
                        </div>

                        <!-- Barrio -->
                        <div class="col-md-4 mb-3">
                            <label for="barrio" class="form-label">Barrio</label>
                            <input type="text" class="form-control" id="barrio" name="barrio" 
                                   value="{{ paciente.barrio if paciente else '' }}">
                        </div>

                        <!-- Localidad con búsqueda y alta libre -->
                        <div class="col-md-4 mb-3">
                            <label for="localidad_nombre" class="form-label">Localidad</label>
                            <input list="localidades_datalist" class="form-control" id="localidad_nombre" name="localidad_nombre"
                                   placeholder="Escribe o elige..."
                                   value="{{ paciente.localidad.nombre if paciente and paciente.localidad else '' }}">
                            <datalist id="localidades_datalist">
                                {% for localidad in localidades %}
                                <option value="{{ localidad.nombre }}"></option>
                                {% endfor %}
                            </datalist>
                            <small class="text-muted">Puedes escribir una localidad nueva; se guardará normalizada.</small>
                        </div>
                    </div>

                    <!-- Sección de Obra Social -->
                    <hr class="my-4">
                    <h5 class="mb-3">Obra Social</h5>
                    <div class="row">
                        <!-- Obra Social -->
                        <div class="col-md-12 mb-3">
                            <label for="obra_social_id" class="form-label">Obra Social</label>
                            <select class="form-select" id="obra_social_id" name="obra_social_id">
                                <option value="">Seleccionar obra social...</option>
                                {% for obra_social in obras_sociales %}
                                <option value="{{ obra_social.id }}" 
                                        {% if paciente and paciente.obra_social_id == obra_social.id %}selected{% endif %}>
                                    {{ obra_social.nombre }}
                                </option>
                                {% endfor %}
                            </select>
                        </div>
                    </div>

                    <!-- Campos condicionales según obra social -->
                    {% set obra_social_text = (paciente.obra_social.nombre|lower) if paciente and paciente.obra_social else '' %}
                    {% set show_ipss = obra_social_text and 'ipss' in obra_social_text %}
                    {% set show_otros = obra_social_text and ('ipss' not in obra_social_text) and ('particular' not in obra_social_text) %}

                    <div id="campos-ipss" style="display: {{ 'block' if show_ipss else 'none' }};">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="nro_afiliado" class="form-label">Nro Afiliado</label>
                                    <input type="text" class="form-control" id="nro_afiliado" name="carnet" 
                                        value="{{ paciente.nro_afiliado if paciente else '' }}">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="titular_ipss" class="form-label">Titular</label>
                                <input type="text" class="form-control" id="titular_ipss" name="titular" 
                                       value="{{ paciente.titular if paciente else '' }}">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="parentesco_ipss" class="form-label">Parentesco</label>
                                <input type="text" class="form-control" id="parentesco_ipss" name="parentesco" 
                                       value="{{ paciente.parentesco if paciente else '' }}">
                            </div>
                        </div>
                    </div>

                    <!-- Campos para otras obras sociales -->
                    <div id="campos-otros" style="display: {{ 'block' if show_otros else 'none' }};">
                        <div class="row">
                            <div class="col-md-4 mb-3">
                                <label for="carnet" class="form-label">Nro de Afiliado</label>
                                    <input type="text" class="form-control" id="carnet" name="carnet" 
                                        value="{{ paciente.nro_afiliado if paciente else '' }}">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="titular" class="form-label">Titular</label>
                                <input type="text" class="form-control" id="titular" name="titular" 
                                       value="{{ paciente.titular if paciente else '' }}">
                            </div>
                            <div class="col-md-4 mb-3">
                                <label for="parentesco" class="form-label">Parentesco</label>
                                <input type="text" class="form-control" id="parentesco" name="parentesco" 
                                       value="{{ paciente.parentesco if paciente else '' }}">
                            </div>
                        </div>
                    </div>

                    <!-- Botones -->
                    <div class="d-flex justify-content-between">
                        <a href="{{ url_for('main.listar_pacientes') }}" class="btn btn-secondary">
                            <i class="bi bi-arrow-left"></i> Cancelar
                        </a>
                        <button type="submit" class="btn btn-primary">
                            {% if paciente %}
                                <i class="bi bi-check-lg"></i> Actualizar Paciente
                            {% else %}
                                <i class="bi bi-plus-lg"></i> Crear Paciente
                            {% endif %}
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Función para mostrar/ocultar campos según obra social
function actualizarCamposObraSocial() {
    const obraSocialSelect = document.getElementById('obra_social_id');
    const obraSocialText = (obraSocialSelect.options[obraSocialSelect.selectedIndex]?.text || '').toLowerCase().trim();

    const camposIpss = document.getElementById('campos-ipss');
    const camposOtros = document.getElementById('campos-otros');

    // Helper para limpiar los campos relacionados a la obra social
    const clearFields = () => {
        ['nro_afiliado', 'carnet', 'titular', 'titular_ipss', 'parentesco', 'parentesco_ipss']
            .forEach(id => { const el = document.getElementById(id); if (el) el.value = ''; });
    };

    if (obraSocialText.includes('ipss')) {
        camposIpss.style.display = 'block';
        camposOtros.style.display = 'none';
    } else if (obraSocialText.includes('particular')) {
        // Para PARTICULAR ocultamos y limpiamos los campos relacionados
        camposIpss.style.display = 'none';
        camposOtros.style.display = 'none';
        clearFields();
    } else if (obraSocialText === '') {
        camposIpss.style.display = 'none';
        camposOtros.style.display = 'none';
    } else {
        camposIpss.style.display = 'none';
        camposOtros.style.display = 'block';
    }
}

// Inicializar al cargar la página
document.addEventListener('DOMContentLoaded', function() {
    actualizarCamposObraSocial();
    
    // Listener para cambios en la selección de obra social
    document.getElementById('obra_social_id').addEventListener('change', actualizarCamposObraSocial);
});

// Validación de DNI
document.getElementById('dni').addEventListener('input', function() {
    this.value = this.value.replace(/\D/g, ''); // Solo números
    if (this.value.length > 8) {
        this.value = this.value.substring(0, 8);
    }
});

// Validación de teléfono
document.getElementById('telefono').addEventListener('input', function() {
    this.value = this.value.replace(/[^\d\-\+\s\(\)]/g, ''); // Solo números y caracteres de teléfono
});
</script>
{% endblock %}
